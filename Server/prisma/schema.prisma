generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id             String   @id @default(uuid())
  name           String?
  email          String?  @unique
  contact        String?
  password       String?
  roleId         String?
  block          String?
  district       String?
  state          String?
  isActive       Boolean?
  refreshToken   String?
  warehouseId    String?
  allotedCompany Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @default(now()) @updatedAt

  updatedItems              ItemRawMaterial[]            @relation("UserUpdates")
  stocks                    StockMovement[]
  services                  ServiceRecord[] // One-to-Many relationship with ServiceRecord
  productionLogs            ProductionLog[]
  role                      Role?                        @relation(fields: [roleId], references: [id])
  stageActivity             StageActivity[]
  itemUsage                 ItemUsage[]
  rawMaterialCreated        RawMaterial[]                @relation("ItemCreatedByUser")
  rawMaterialUpdated        RawMaterial[]                @relation("ItemUpdatedByUser")
  requestedItemRequests     ItemRequestData[]            @relation("RequestedByUser")
  approvedItemRequests      ItemRequestData[]            @relation("ApprovedByUser")
  updatedItemRequests       ItemRequestData[]            @relation("UpdatedByUser")
  declinedItemRequests      ItemRequestData[]            @relation("DeclinedByUser")
  createdServiceProcess     Service_Process_Record[]     @relation("CreatedByUser")
  updatedServiceProcess     Service_Process_Record[]     @relation("UpdatedByUser")
  userItemStock             UserItemStock[]
  stockMovementBatch        StockMovementBatch[]
  Company                   Company[]
  Vendor                    Vendor[]
  BankDetail                BankDetail[]
  PurchaseOrder             PurchaseOrder[]
  PurchaseOrderReceipt      PurchaseOrderReceipt[]
  disassembleTasks          Disassemble_Reusable_Items[] @relation("DisassembleEmployee")
  assembleStockReceives     Disassemble_Reusable_Items[] @relation("AssembleEmployee")
  debitNotes                DebitNote[]
  damagedStocksCreated      DamagedStock[]               @relation("Damaged_Stock_CreatedBy")
  damagedStocksUpdated      DamagedStock[]               @relation("Damaged_Stock_UpdatedBy")
  termsCreatedBy            Terms_Conditions[]           @relation("TermsCreatedBy")
  termsUpdatedBy            Terms_Conditions[]           @relation("TermsUpdatedBy")
  issuedItemsToUser         DirectItemIssue[]            @relation("IssuedToUser")
  issuedItemsByUser         DirectItemIssue[]            @relation("IssuedByUser")
  updatedByUser_DirectIssue DirectItemIssue[]            @relation("UpdatedByUser_DirectIssue")
  paymentsCreated           Payment[]                    @relation("paymentCreatedBy")
  paymentsRequested         Payment[]                    @relation("payment_RequestedBy")
  docApprovedPayments       Payment[]                    @relation("doc_ApprovedBy")
  adminApprovedPayments     Payment[]                    @relation("approvedBy_Admin")
  paymentTransferred        Payment[]                    @relation("payment_TransferredBy")

  invoiceCreated    VendorInvoices[]  @relation("invoice_CreatedBy")
  invoiceUpdated    VendorInvoices[]  @relation("invoice_UpdatedBy")
  infraItemsCreated InfraMaterial[]   @relation("InfraItemCreatedByUser")
  infraItemsUpdated InfraMaterial[]   @relation("InfroItemUpdatedByUser")
  toolsCreatedBy    ToolsEquipments[] @relation("ToolsCreatedByUser")
  toolsUpdatedBy    ToolsEquipments[] @relation("ToolsUpdatedByUser")

  @@index([roleId], map: "User_roleId_fkey")
}

model Role {
  id        String   @id @default(uuid())
  name      String?  @unique
  createdAt DateTime @default(now())
  users     User[]
}

model Warehouse {
  id        String   @id @default(uuid())
  name      String?  @unique
  state     String?
  createdAt DateTime @default(now())
}

model Item {
  id                 String               @id @default(uuid())
  name               String?              @unique
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  rawMaterials       ItemRawMaterial[]
  manufacturingUsage ManufacturingUsage[]
  productionLogs     ProductionLog[]
  productItemMap     Product_Item_Map[]
}

model RawMaterial {
  id               String   @id @default(uuid())
  name             String?  @unique
  stock            Float?
  unit             String?
  hsnCode          String?
  conversionUnit   String?
  conversionFactor Float?
  isUsed           Boolean? @default(true)
  minQty           Float?
  description      String?

  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime @updatedAt
  updatedBy String?

  createdByUser       User?                @relation("ItemCreatedByUser", fields: [createdBy], references: [id])
  updatedByUser       User?                @relation("ItemUpdatedByUser", fields: [updatedBy], references: [id])
  ItemRawMaterial     ItemRawMaterial[]
  manufacturingUsages ManufacturingUsage[]
  serviceUsages       ServiceUsage[]
  stockMovements      StockMovement[]
  itemUsage           ItemUsage[]
  userItemStock       UserItemStock[]
  stageRawMaterial    StageRawMaterial[]
  warehouseStock      WarehouseStock[]
}

model ItemRawMaterial {
  id            String   @id @default(uuid())
  itemId        String?
  itemModelId   String?
  rawMaterialId String?
  quantity      Float?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  updatedBy     String?

  user        User?        @relation("UserUpdates", fields: [updatedBy], references: [id])
  item        Item?        @relation(fields: [itemId], references: [id])
  rawMaterial RawMaterial? @relation(fields: [rawMaterialId], references: [id])
  itemModel   Item_Model?  @relation(fields: [itemModelId], references: [id])

  @@unique([itemId, rawMaterialId])
  @@index([rawMaterialId], map: "ItemRawMaterial_rawMaterialId_fkey")
}

model StageRawMaterial {
  id            String    @id @default(uuid())
  stageId       String?
  rawMaterialId String?
  createdAt     DateTime? @default(now())
  updatedAt     DateTime? @updatedAt

  stage       Stage?       @relation(fields: [stageId], references: [id])
  rawMaterial RawMaterial? @relation(fields: [rawMaterialId], references: [id])

  @@unique([stageId, rawMaterialId])
}

enum ItemCategory {
  RAW
  INFRA
  TOOL
  INSTALLATION
}

model WarehouseStock {
  id              String        @id @default(uuid())
  warehouseId     String? // MongoDB warehouse _id
  rawMaterialId   String?
  infraItemId     String?
  toolEquipmentId String?
  itemId          String?
  itemType        ItemCategory?
  quantity        Float?        @default(0)
  damagedQty      Float?        @default(0)
  unit            String?
  isUsed          Boolean?      @default(true)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  rawMaterial     RawMaterial?     @relation(fields: [rawMaterialId], references: [id])
  infraItem       InfraMaterial?   @relation(fields: [infraItemId], references: [id])
  toolsEquipments ToolsEquipments? @relation(fields: [toolEquipmentId], references: [id])

  @@unique([warehouseId, rawMaterialId])
  @@unique([warehouseId, infraItemId])
  @@unique([warehouseId, toolEquipmentId])
  @@index([warehouseId])
}

model StockMovementBatch {
  id         String    @id @default(uuid())
  billPhotos Json? // Array of URLs stored as JSON
  createdAt  DateTime? @default(now())
  createdBy  String?

  user          User?           @relation(fields: [createdBy], references: [id])
  stockMovement StockMovement[]
}

model StockMovement {
  id              String        @id @default(uuid())
  batchId         String?
  rawMaterialId   String?
  infraItemId     String?
  toolEquipmentId String?
  userId          String?
  warehouseId     String?
  itemId          String?
  itemType        ItemCategory?
  quantity        Float?
  unit            String?
  type            String?
  timestamp       DateTime      @default(now())

  rawMaterial     RawMaterial?        @relation(fields: [rawMaterialId], references: [id])
  infraItem       InfraMaterial?      @relation(fields: [infraItemId], references: [id])
  user            User?               @relation(fields: [userId], references: [id])
  batch           StockMovementBatch? @relation(fields: [batchId], references: [id])
  toolsEquipments ToolsEquipments?    @relation(fields: [toolEquipmentId], references: [id])

  @@index([rawMaterialId], map: "StockMovement_rawMaterialId_fkey")
  @@index([warehouseId], map: "StockMovement_warehouseId_fkey")
}

model ManufacturingUsage {
  id                String       @id @default(uuid())
  itemId            String?
  rawMaterialId     String?
  quantityUsed      Float?
  unit              String? // Reference to Unit 
  manufacturingDate DateTime     @default(now())
  item              Item?        @relation(fields: [itemId], references: [id])
  rawMaterial       RawMaterial? @relation(fields: [rawMaterialId], references: [id])

  @@index([itemId], map: "ManufacturingUsage_itemId_fkey")
  @@index([rawMaterialId], map: "ManufacturingUsage_rawMaterialId_fkey")
}

model ProductionLog {
  id                String   @id @default(uuid())
  itemId            String
  subItem           String // NEW FIELD
  quantityProduced  Int
  manufacturingDate DateTime @default(now())
  userId            String
  item              Item?    @relation(fields: [itemId], references: [id])
  user              User?    @relation(fields: [userId], references: [id])
}

model ServiceRecord {
  id                 String   @id @default(uuid()) // Unique Service Record ID
  item               String? // Main item being repaired (e.g., motor)  //Motor
  subItem            String? // Sub-item (e.g., capacitor, fuse) //MOTOR 10HP AC 380V
  quantity           Float? // Quantity of items handled    //1
  serialNumber       String? // Serial number of the serviced item //ABCB1234
  faultAnalysis      Json? // Description of the fault or issue found  //Stamp Damaged
  isRepaired         Boolean? // Whether the main item was fixed //true
  repairedRejectedBy String? // Name of the technician //Shiv
  remarks            String? // Additional repair notes // Defective Items
  repairedParts      Json? // Array of objects: [{ rawMaterialId: "123", quantity: 2 }]
  initialRCA         Json?

  userId String // User who created the record (foreign key)
  user   User   @relation(fields: [userId], references: [id]) // Relationship to User model

  servicedAt DateTime @default(now()) // Service date
  updatedAt  DateTime @updatedAt // Automatically updated timestamp

  serviceUsages ServiceUsage[] // Relationship to parts usage

  @@index([serialNumber], map: "ServiceRecord_serialNumber_idx") // Index on serialNumber for fast lookups
  @@index([userId], map: "ServiceRecord_userId_idx") // Index on userId for efficient queries
}

model ServiceUsage {
  id            String  @id @default(uuid()) // Unique ID
  serviceId     String // Foreign key to ServiceRecord (One-to-Many)
  rawMaterialId String? // Material/part used
  quantityUsed  Float? // Quantity used in this service
  // isRepaired    Boolean?       // Indicates if the part was repaired/replaced
  // remarks       String?        // Additional notes for this part usage
  unit          String? // Reference to Unit

  // Relationships
  rawMaterial RawMaterial?   @relation(fields: [rawMaterialId], references: [id]) // Part reference
  service     ServiceRecord? @relation(fields: [serviceId], references: [id]) // Linked service record

  // Timestamps
  createdAt DateTime @default(now()) // Record creation time
  updatedAt DateTime @updatedAt // Last modification time

  @@index([serviceId], map: "ServiceUsage_serviceId_fkey") // Index for service lookups
  @@index([rawMaterialId], map: "ServiceUsage_rawMaterialId_fkey") // Index for material lookups
}

model Unit {
  id        String   @id @default(uuid())
  name      String   @unique // Example: "kg", "liters", "pieces"
  createdAt DateTime @default(now())
}

model Stage {
  id                               String                   @id @default(uuid())
  name                             String                   @unique
  description                      String?
  createdAt                        DateTime                 @default(now())
  updatedAt                        DateTime                 @updatedAt
  stageActivity                    StageActivity[]
  serviceProcess                   Service_Process_Record[]
  itemTypeStage                    ItemType_Stage[]
  serviceProcessInitialStage       Service_Process_Record[] @relation("InitialStage")
  serviceProcessRestartedFromStage Service_Process_Record[] @relation("RestartedFrom")
  stageFlowCurrentStage            StageFlow[]              @relation("CurrentStage")
  stageFlowNextStage               StageFlow[]              @relation("NextStage")
  failureRedirectStage             FailureRedirect[]
  stageRawMaterial                 StageRawMaterial[]

  @@map("Stage")
}

model ItemType {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  serviceProcess  Service_Process_Record[]
  itemTypeStage   ItemType_Stage[]
  stageFlow       StageFlow[]
  failureRedirect FailureRedirect[]

  @@map("ItemType")
}

enum FailureReason {
  VIBRATION
  OVERLOAD
  EARTHING
  LEAKAGE
  HIGH_PLAY
  NOISE
  REJECTED
  OTHER
}

enum ActivityStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  REJECTED
  SKIPPED
}

model StageActivity {
  id               String         @id @default(uuid())
  serviceProcessId String?
  empId            String?
  stageId          String?
  status           ActivityStatus @default(PENDING)
  isCurrent        Boolean        @default(false)
  failureReason    FailureReason?
  remarks          String?
  outcome          String?
  acceptedAt       DateTime?
  startedAt        DateTime?
  completedAt      DateTime?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  serviceProcess Service_Process_Record? @relation(fields: [serviceProcessId], references: [id])
  stage          Stage?                  @relation(fields: [stageId], references: [id])
  user           User?                   @relation(fields: [empId], references: [id])

  @@map("StageActivity")
}

model ItemType_Stage {
  id         String   @id @default(uuid())
  itemTypeId String?
  stageId    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  itemType ItemType? @relation(fields: [itemTypeId], references: [id])
  stage    Stage?    @relation(fields: [stageId], references: [id])

  @@map("ItemType_Stage")
}

model ItemRequestData {
  id                   String    @id @default(uuid())
  warehouseId          String?
  serviceProcessId     String?
  isProcessRequest     Boolean   @default(false) // true = tied to specific process, false = advance/global
  rawMaterialRequested Json?
  materialRequested    Json?
  requestedTo          String?
  requestedBy          String?
  requestedAt          DateTime  @default(now())
  approved             Boolean?
  approvedBy           String?
  approvedAt           DateTime?
  declined             Boolean?
  declinedBy           String?
  declinedAt           DateTime?
  declinedRemarks      String?
  materialGiven        Boolean?
  updatedAt            DateTime? @updatedAt
  updatedBy            String?

  //Relation
  serviceProcess  Service_Process_Record? @relation(fields: [serviceProcessId], references: [id])
  requestedByUser User?                   @relation("RequestedByUser", fields: [requestedBy], references: [id])
  approvedByUser  User?                   @relation("ApprovedByUser", fields: [approvedBy], references: [id])
  updatedByUser   User?                   @relation("UpdatedByUser", fields: [updatedBy], references: [id])
  declinedByUser  User?                   @relation("DeclinedByUser", fields: [declinedBy], references: [id])

  @@map("ItemRequestData")
}

model DirectItemIssue {
  id               String  @id @default(uuid())
  warehouseId      String?
  serviceProcessId String? // optional, if issue is tied to a process
  isProcessIssue   Boolean @default(false)

  rawMaterialIssued Json? // same structure as rawMaterialRequested
  materialIssued    Json?
  issuedTo          String? // Line worker (receiver)
  issuedBy          String? // Storekeeper (issuer)
  issuedAt          DateTime @default(now())
  issuedToName      String?
  department        String?
  remarks           String?

  updatedAt DateTime? @updatedAt
  updatedBy String?

  // Relations
  serviceProcess Service_Process_Record? @relation(fields: [serviceProcessId], references: [id])

  issuedToUser  User? @relation("IssuedToUser", fields: [issuedTo], references: [id])
  issuedByUser  User? @relation("IssuedByUser", fields: [issuedBy], references: [id])
  updatedByUser User? @relation("UpdatedByUser_DirectIssue", fields: [updatedBy], references: [id])

  @@map("DirectItemIssue")
}

enum ProcessStatus {
  PENDING
  IN_PROGRESS
  FAILED
  REDIRECTED
  COMPLETED
}

model Service_Process_Record {
  id                   String        @id @default(uuid())
  warehouseId          String?
  productName          String?
  itemName             String?
  subItemName          String?
  itemTypeId           String?
  serialNumber         String?
  quantity             Float?
  stageId              String?
  initialStageId       String? // NEW - where it originally started
  restartedFromStageId String? // NEW - where it restarted from
  status               ProcessStatus @default(PENDING)
  finalStatus          String? // REPAIRED, REJECTED, PRODUCED, FAILED
  isClosed             Boolean       @default(false)
  isRepaired           Boolean?
  finalRemarks         String?
  isDisassemblePending Boolean?      @default(false)
  disassembleSessionId String?
  disassembleStatus    String?
  createdAt            DateTime      @default(now())
  createdBy            String?
  updatedAt            DateTime      @updatedAt
  updatedBy            String?
  completedAt          DateTime?

  itemType           ItemType? @relation(fields: [itemTypeId], references: [id])
  stage              Stage?    @relation(fields: [stageId], references: [id])
  initialStage       Stage?    @relation("InitialStage", fields: [initialStageId], references: [id])
  restartedFromStage Stage?    @relation("RestartedFrom", fields: [restartedFromStageId], references: [id])

  createdUser User? @relation("CreatedByUser", fields: [createdBy], references: [id])
  updatedUser User? @relation("UpdatedByUser", fields: [updatedBy], references: [id])

  itemRequestData     ItemRequestData[]
  stageActivity       StageActivity[]
  serviceProcessUsage ItemUsage[]
  reusableItems       Disassemble_Reusable_Items[]
  directItemIssues    DirectItemIssue[]

  @@index([serialNumber])
  @@index([itemName])
  @@index([subItemName])
  @@index([createdAt])
  @@index([stageId])
  @@index([itemTypeId])
  @@index([status])
  @@map("Service_Process_Record")
}

model StageFlow {
  id             String   @id @default(uuid())
  productId      String?
  itemTypeId     String?
  currentStageId String?
  nextStageId    String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  product      Product?  @relation(fields: [productId], references: [id])
  itemType     ItemType? @relation(fields: [itemTypeId], references: [id])
  currentStage Stage?    @relation("CurrentStage", fields: [currentStageId], references: [id])
  nextStage    Stage?    @relation("NextStage", fields: [nextStageId], references: [id])

  @@map("StageFlow")
}

model FailureRedirect {
  id              String        @id @default(uuid())
  productId       String?
  itemTypeId      String? // Optional if universal
  failureReason   FailureReason
  redirectStageId String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  itemType      ItemType? @relation(fields: [itemTypeId], references: [id])
  redirectStage Stage?    @relation(fields: [redirectStageId], references: [id])
  product       Product?  @relation(fields: [productId], references: [id])

  @@map("FailureRedirect")
}

model ItemUsage {
  id               String        @id @default(uuid())
  serviceProcessId String?
  empId            String?
  rawMaterialId    String?
  itemId           String?
  itemType         ItemCategory?
  quantityUsed     Float?
  unit             String?

  rawMaterial    RawMaterial?            @relation(fields: [rawMaterialId], references: [id])
  serviceProcess Service_Process_Record? @relation(fields: [serviceProcessId], references: [id])
  user           User?                   @relation(fields: [empId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("ItemUsage")
}

model UserItemStock {
  id            String        @id @default(uuid())
  empId         String?
  rawMaterialId String?
  itemId        String?
  itemType      ItemCategory?
  quantity      Float         @default(0)
  unit          String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  user        User?        @relation(fields: [empId], references: [id])
  rawMaterial RawMaterial? @relation(fields: [rawMaterialId], references: [id])

  @@unique([empId, rawMaterialId])
  @@unique([empId, itemId, itemType])
  @@map("UserItemStock")
}

model Disassemble_Reusable_Items {
  id               String   @id @default(uuid())
  serviceProcessId String
  empId            String?
  assembleEmpId    String?
  reusableItems    Json?
  remarks          String?
  createdAt        DateTime @default(now())

  disassembleEmp       User?                  @relation("DisassembleEmployee", fields: [empId], references: [id])
  assembleEmp          User?                  @relation("AssembleEmployee", fields: [assembleEmpId], references: [id])
  serviceProcessRecord Service_Process_Record @relation(fields: [serviceProcessId], references: [id])
}

model Item_Model {
  id        String   @id @default(uuid())
  model     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  itemRawMaterial ItemRawMaterial[]
}

model BOMEntry {
  id            String  @id @default(uuid())
  itemId        String?
  rawMaterialId String?
  quantity      Float?
}

enum Country {
  INDIA
  USA
  UAE
  UK
  CHINA
  RUSSIA
}

enum Currency {
  INR
  USD
  EUR
  GBP
  AED
  CNY
}

enum GSTType {
  IGST_5
  IGST_12
  IGST_18
  IGST_28
  IGST_EXEMPTED

  LGST_5
  LGST_12
  LGST_18
  LGST_28
  LGST_EXEMPTED

  IGST_ITEMWISE
  LGST_ITEMWISE
}

enum POStatus {
  Draft
  Generated_Downloaded
  Approval_Sent
  Admin_Approved
  Admin_Rejected
  PartiallyReceived
  Received
  Cancelled
}

enum PaymentMode {
  Cash
  NEFT
  UPI
  Cheque
}

enum POApprovalStatus {
  Pending
  Approved
  Rejected
}

model Product {
  id          String   @id @default(uuid())
  productName String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  productItemMap  Product_Item_Map[]
  stageFlow       StageFlow[]
  failureRedirect FailureRedirect[]
}

model Product_Item_Map {
  id        String   @id @default(uuid())
  productId String?
  itemId    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product Product? @relation(fields: [productId], references: [id])
  item    Item?    @relation(fields: [itemId], references: [id])

  @@unique([productId, itemId], name: "unique_product_item")
}

model PanelMaster {
  id         String   @id @default(uuid())
  panelType  String?
  moduleType String?
  dcrType    String?
  wattage    String?
  hsnCode    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Company {
  id              String   @id @default(uuid())
  name            String
  companyCode     String?
  gstNumber       String?
  address         String?
  city            String?
  state           String?
  pincode         String?
  contactNumber   String?
  alternateNumber String?
  email           String?
  country         String?  @default("INDIA")
  currency        String?  @default("INR")
  companyAadhaar  String?
  companyPanCard  String?
  accountHolder   String?
  bankName        String?
  accountNumber   String?
  ifscCode        String?
  isActive        Boolean? @default(true)
  createdBy       String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  purchaseOrders PurchaseOrder[]
  bankAccounts   BankDetail[]
  user           User            @relation(fields: [createdBy], references: [id])
  debitNotes     DebitNote[]
}

model Vendor {
  id                String   @id @default(uuid())
  name              String
  email             String?
  mailVerified      Boolean? @default(false)
  gstNumber         String?
  address           String?
  city              String?
  state             String?
  pincode           String?
  zipCode           String?
  country           String?  @default("INDIA")
  currency          String?  @default("INR")
  exchangeRate      Decimal?
  contactPerson     String?
  contactNumber     String?
  contactNoVerified Boolean? @default(false)
  alternateNumber   String?
  vendorAadhaar     String?
  aadhaarUrl        String?
  vendorPanCard     String?
  pancardUrl        String?
  accountHolder     String?
  bankName          String?
  accountNumber     String?
  ifscCode          String?
  referenceBy       String?

  isActive  Boolean? @default(true)
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  purchaseOrders PurchaseOrder[]
  bankAccounts   BankDetail[]
  returnToVendor ReturnToVendor[]
  user           User             @relation(fields: [createdBy], references: [id])
  debitNotes     DebitNote[]
  vendorInvoices VendorInvoices[]
}

model BankDetail {
  id            String   @id @default(uuid())
  accountHolder String
  bankName      String
  branchName    String?
  accountNumber String
  ifscCode      String
  accountType   String?  @default("Current")
  isPrimary     Boolean  @default(false)
  vendorId      String?
  companyId     String?
  createdBy     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  vendor         Vendor?         @relation(fields: [vendorId], references: [id])
  company        Company?        @relation(fields: [companyId], references: [id])
  user           User?           @relation(fields: [createdBy], references: [id])
  purchaseOrders PurchaseOrder[]
  debitNotes     DebitNote[]
}

model Counter {
  id            String  @id @default(uuid())
  name          String  @unique
  companyId     String?
  financialYear String?
  seq           Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PurchaseOrder {
  id            String   @id @default(uuid())
  heading       String?
  poNumber      String   @unique
  financialYear String?
  companyId     String
  companyName   String?
  vendorId      String
  vendorName    String?
  bankDetailId  String?
  createdBy     String?
  poDate        DateTime @default(now())
  gstType       GSTType
  gstRate       Decimal? @db.Decimal(7, 4)

  currency     String?  @default("INR")
  exchangeRate Decimal? @default(1.0000) @db.Decimal(12, 4)

  foreignSubTotal   Decimal? @db.Decimal(12, 4)
  foreignGrandTotal Decimal? @db.Decimal(12, 4)

  subTotal             Decimal?         @db.Decimal(12, 4)
  totalCGST            Decimal?         @db.Decimal(12, 4)
  totalSGST            Decimal?         @db.Decimal(12, 4)
  totalIGST            Decimal?         @db.Decimal(12, 4)
  totalGST             Decimal?         @db.Decimal(12, 4)
  grandTotal           Decimal?         @db.Decimal(12, 4)
  fixedGrandTotal      Decimal?         @db.Decimal(12, 4)
  status               POStatus         @default(Draft)
  approvalStatus       POApprovalStatus @default(Pending)
  approvedBy           String?
  rejectedBy           String?
  approvedAt           DateTime?
  rejectedAt           DateTime?
  rejectionReason      String?
  remarks              String?
  pdfUrl               String?
  pdfName              String?
  pdfGeneratedAt       DateTime?
  pdfGeneratedBy       String?
  emailSentAt          DateTime?
  emailSentBy          String?
  emailResentCount     Int              @default(0)
  emailLastResentAt    DateTime?
  paymentTerms         String?
  deliveryTerms        String?
  contactPerson        String?
  cellNo               String?
  warranty             String?
  expectedDeliveryDate DateTime?

  otherCharges      Json?
  warehouseId       String?
  warehouseName     String?
  termsConditionsId String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  company                  Company                   @relation(fields: [companyId], references: [id])
  vendor                   Vendor                    @relation(fields: [vendorId], references: [id])
  bankDetail               BankDetail?               @relation(fields: [bankDetailId], references: [id])
  termsConditions          Terms_Conditions?         @relation(fields: [termsConditionsId], references: [id])
  items                    PurchaseOrderItem[]
  payments                 Payment[]
  returnToVendor           ReturnToVendor[]
  damagedStock             DamagedStock[]
  receipts                 PurchaseOrderReceipt[]    @relation("PO_Receipts") // PO → Receipts
  bills                    PurchaseOrderBill[]
  user                     User?                     @relation(fields: [createdBy], references: [id])
  purchaseOrDebitNoteTerms PurchaseOrDebitNoteTerm[]
  invoices                 VendorInvoices[]
}

model PurchaseOrderItem {
  id              String   @id @default(uuid())
  purchaseOrderId String
  itemId          String
  itemSource      String
  itemName        String
  hsnCode         String?
  modelNumber     String?
  itemDetail      String?  @db.VarChar(500)
  unit            String?
  rateInForeign   Decimal? @db.Decimal(12, 4) // optional, if PO currency != INR
  amountInForeign Decimal? @db.Decimal(12, 4) // rate * quantity in foreign currency
  rate            Decimal  @db.Decimal(12, 4)
  gstRate         Decimal? @db.Decimal(7, 4)
  quantity        Decimal  @db.Decimal(12, 4)
  receivedQty     Decimal? @default(0) @db.Decimal(12, 4)
  itemGSTType     String?
  total           Decimal  @db.Decimal(12, 4)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  returnToVendor ReturnToVendor[]
  purchaseOrder  PurchaseOrder          @relation(fields: [purchaseOrderId], references: [id])
  receipts       PurchaseOrderReceipt[] @relation("Item_Receipts") // Item → Receipts
  debitNote      DebitNote?             @relation(fields: [debitNoteId], references: [id])
  debitNoteId    String?
}

model PurchaseOrderReceipt {
  id                  String   @id @default(uuid())
  purchaseOrderId     String?
  purchaseOrderItemId String?
  invoiceNumber       String?
  itemId              String?
  itemSource          String?
  itemName            String?
  receivedQty         Decimal? @db.Decimal(10, 2)
  goodQty             Decimal? @default(0) @db.Decimal(10, 2)
  damagedQty          Decimal? @default(0) @db.Decimal(10, 2)

  receivingBill String?
  receivedDate  DateTime @default(now())
  remarks       String?
  createdBy     String?
  createdAt     DateTime @default(now())

  returnToVendor    ReturnToVendor[]
  purchaseOrder     PurchaseOrder?     @relation("PO_Receipts", fields: [purchaseOrderId], references: [id])
  purchaseOrderItem PurchaseOrderItem? @relation("Item_Receipts", fields: [purchaseOrderItemId], references: [id])
  user              User?              @relation(fields: [createdBy], references: [id])
  debitNote         DebitNote?         @relation(fields: [debitNoteId], references: [id])
  debitNoteId       String?
}

enum DamageStatus {
  Pending
  Debited
  Resolved
}

model DamagedStock {
  id              String       @id @default(uuid())
  purchaseOrderId String?
  debitNoteId     String?
  invoiceNumber   String?
  itemId          String?
  itemSource      String?
  itemName        String?
  hsnCode         String?
  modelNumber     String?
  itemDetail      String?      @db.VarChar(500)
  unit            String?
  rateInForeign   Decimal?     @db.Decimal(12, 4) // optional, if Debit Note currency != INR
  amountInForeign Decimal?     @db.Decimal(12, 4) // rate * quantity in foreign currency
  rate            Decimal?     @db.Decimal(12, 4)
  gstRate         Decimal?     @db.Decimal(7, 4)
  quantity        Decimal      @db.Decimal(12, 4)
  receivedQty     Decimal?     @default(0) @db.Decimal(12, 4)
  itemGSTType     String?
  total           Decimal?     @db.Decimal(12, 4)
  remarks         String?
  status          DamageStatus @default(Pending)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  createdBy       String?
  updatedBy       String?

  purchaseOrder         PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id])
  damagedStockCreatedBy User?          @relation("Damaged_Stock_CreatedBy", fields: [createdBy], references: [id])
  damagedStockUpdatedBy User?          @relation("Damaged_Stock_UpdatedBy", fields: [updatedBy], references: [id])
  debitNote             DebitNote?     @relation(fields: [debitNoteId], references: [id])
}

model PurchaseOrderBill {
  id              String   @id @default(uuid())
  purchaseOrderId String
  invoiceNumber   String?
  fileName        String
  fileUrl         String
  mimeType        String
  uploadedBy      String
  createdAt       DateTime @default(now())

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
}

enum DebitNoteStatus {
  Debited
  PartiallyReceived
  Received
  Cancelled
}

enum DebitNoteApprovalStatus {
  Pending
  Approved
  Rejected
}

model DebitNote {
  id              String   @id @default(uuid())
  debitNoteNo     String   @unique
  financialYear   String?
  purchaseOrderId String?
  companyId       String
  companyName     String?
  vendorId        String
  vendorName      String?
  billReference   String?
  bankDetailId    String?
  createdBy       String?
  drNoteDate      DateTime @default(now())
  gstType         GSTType
  gstRate         Decimal? @db.Decimal(7, 4)

  currency     String?  @default("INR")
  exchangeRate Decimal? @default(1.0000) @db.Decimal(12, 4)

  foreignSubTotal   Decimal? @db.Decimal(12, 4)
  foreignGrandTotal Decimal? @db.Decimal(12, 4)

  subTotal        Decimal?                @db.Decimal(12, 4)
  totalCGST       Decimal?                @db.Decimal(12, 4)
  totalSGST       Decimal?                @db.Decimal(12, 4)
  totalIGST       Decimal?                @db.Decimal(12, 4)
  totalGST        Decimal?                @db.Decimal(12, 4)
  grandTotal      Decimal?                @db.Decimal(12, 4)
  fixedGrandTotal Decimal?                @db.Decimal(12, 4)
  status          DebitNoteStatus         @default(Debited)
  approvalStatus  DebitNoteApprovalStatus @default(Pending)
  approvedBy      String?
  approvedAt      DateTime?
  rejectionReason String?
  remarks         String?
  pdfUrl          String?
  pdfName         String?
  pdfGeneratedAt  DateTime?
  pdfGeneratedBy  String?
  orgInvoiceNo    String?
  orgInvoiceDate  DateTime?
  gr_rr_no        String?
  transport       String?
  vehicleNumber   String?
  station         String?

  otherCharges         Json?
  warehouseId          String?
  warehouseName        String?
  expectedDeliveryDate DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company                  Company                   @relation(fields: [companyId], references: [id])
  vendor                   Vendor                    @relation(fields: [vendorId], references: [id])
  bankDetail               BankDetail?               @relation(fields: [bankDetailId], references: [id])
  payments                 Payment[]
  returnToVendor           ReturnToVendor[]
  damagedStock             DamagedStock[]
  debitNoteBills           DebitNoteBill[]
  user                     User?                     @relation(fields: [createdBy], references: [id])
  purchaseOrderItems       PurchaseOrderItem[]
  purchaseOrderReceipts    PurchaseOrderReceipt[]
  purchaseOrDebitNoteTerms PurchaseOrDebitNoteTerm[]
}

model DebitNoteBill {
  id            String   @id @default(uuid())
  debitNoteId   String
  invoiceNumber String?
  fileName      String
  fileUrl       String
  mimeType      String
  uploadedBy    String
  createdAt     DateTime @default(now())

  debitNote DebitNote @relation(fields: [debitNoteId], references: [id])
}

model Terms_Conditions {
  id        String   @id @default(uuid())
  heading   String?
  terms     Json?
  isActive  Boolean? @default(true)
  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime @updatedAt
  updatedBy String?

  TermsCreatedBy           User?                     @relation("TermsCreatedBy", fields: [createdBy], references: [id])
  TermsUpdatedBy           User?                     @relation("TermsUpdatedBy", fields: [updatedBy], references: [id])
  purchaseOrDebitNoteTerms PurchaseOrDebitNoteTerm[]
  purchaseOrders           PurchaseOrder[]
}

model PurchaseOrDebitNoteTerm {
  id              String  @id @default(uuid())
  purchaseOrderId String?
  debitNoteId     String?
  termId          String

  createdAt DateTime @default(now())

  purchaseOrder PurchaseOrder?   @relation(fields: [purchaseOrderId], references: [id])
  debitNote     DebitNote?       @relation(fields: [debitNoteId], references: [id])
  term          Terms_Conditions @relation(fields: [termId], references: [id])

  @@unique([purchaseOrderId, termId])
  @@unique([debitNoteId, termId])
  @@index([purchaseOrderId])
  @@index([debitNoteId])
}

model ReturnToVendor {
  id                  String       @id @default(uuid())
  returnNumber        String       @unique
  purchaseOrderId     String
  purchaseOrderItemId String?
  receiptId           String? // Link to the specific receipt that caused the return
  vendorId            String
  reason              String?
  damagedQty          Decimal      @db.Decimal(10, 2)
  returnDate          DateTime     @default(now())
  transporterName     String?
  vehicleNo           String?
  challanNo           String?
  pdfUrl              String?
  createdBy           String?
  status              ReturnStatus @default(Pending)
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  vendor            Vendor                @relation(fields: [vendorId], references: [id])
  purchaseOrder     PurchaseOrder         @relation(fields: [purchaseOrderId], references: [id])
  purchaseOrderItem PurchaseOrderItem?    @relation(fields: [purchaseOrderItemId], references: [id])
  receipt           PurchaseOrderReceipt? @relation(fields: [receiptId], references: [id])
  debitNote         DebitNote?            @relation(fields: [debitNoteId], references: [id])
  debitNoteId       String?
}

enum ReturnStatus {
  Pending
  InTransit
  ReceivedByVendor
  Closed
}

enum BillPaymentType {
  Advance_Payment
  Partial_Payment
  Full_Payment
  Full_Payment_In_Advance
}

model Payment {
  id                   String           @id @default(uuid())
  poId                 String
  debitNoteId          String?
  paymentRequestedBy   String?
  docApprovedBy        String?
  docApprovalStatus    Boolean?
  docApprovalDate      DateTime?
  docApprovalRemark    String?
  approvedByAdmin      String?
  adminApprovalStatus  Boolean?
  adminApprovalDate    DateTime?
  adminRemark          String?
  paymentTransferredBy String?
  paymentStatus        Boolean?
  paymentRemark        String?
  paymentDate          DateTime?
  amount               Decimal          @db.Decimal(12, 4)
  billpaymentType      BillPaymentType?
  createdAt            DateTime?        @default(now())
  createdBy            String?
  updatedAt            DateTime?        @updatedAt
  updatedBy            String?

  purchaseOrder         PurchaseOrder @relation(fields: [poId], references: [id])
  debitNote             DebitNote?    @relation(fields: [debitNoteId], references: [id])
  paymentCreatedBy      User?         @relation("paymentCreatedBy", fields: [createdBy], references: [id])
  payment_RequestedBy   User?         @relation("payment_RequestedBy", fields: [paymentRequestedBy], references: [id])
  doc_ApprovedBy        User?         @relation("doc_ApprovedBy", fields: [docApprovedBy], references: [id])
  approvedBy_Admin      User?         @relation("approvedBy_Admin", fields: [approvedByAdmin], references: [id])
  payment_TransferredBy User?         @relation("payment_TransferredBy", fields: [paymentTransferredBy], references: [id])

  @@index([poId])
  @@index([debitNoteId])
  @@index([createdBy])
}

model AuditLog {
  id          String   @id @default(uuid())
  entityType  String
  entityId    String
  action      String
  performedBy String?
  oldValue    Json?
  newValue    Json?
  timestamp   DateTime @default(now())
}

model VendorInvoices {
  id            String   @id @default(uuid())
  vendorId      String
  poId          String?
  invoiceNumber String?
  invoiceUrl    String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  createdBy     String?
  updatedBy     String?

  invoiceCreatedBy User?          @relation("invoice_CreatedBy", fields: [createdBy], references: [id])
  invoiceUpdatedBy User?          @relation("invoice_UpdatedBy", fields: [updatedBy], references: [id])
  vendor           Vendor?        @relation(fields: [vendorId], references: [id])
  purchaseOrder    PurchaseOrder? @relation(fields: [poId], references: [id])

  @@unique([vendorId, poId, invoiceNumber])
}

model InfraMaterial {
  id               String   @id @default(uuid())
  name             String?  @unique
  unit             String?
  hsnCode          String?
  conversionUnit   String?
  conversionFactor Float?
  isUsed           Boolean? @default(true)
  description      String?

  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime @updatedAt
  updatedBy String?

  infraItemCreatedBy User?            @relation("InfraItemCreatedByUser", fields: [createdBy], references: [id])
  infraItemUpdatedBy User?            @relation("InfroItemUpdatedByUser", fields: [updatedBy], references: [id])
  warehouseStocks    WarehouseStock[]
  stockMovements     StockMovement[]
}

model ToolsEquipments {
  id               String   @id @default(uuid())
  name             String?  @unique
  unit             String?
  hsnCode          String?
  conversionUnit   String?
  conversionFactor Float?
  isUsed           Boolean? @default(true)
  description      String?

  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime @updatedAt
  updatedBy String?

  toolsCreatedBy  User?            @relation("ToolsCreatedByUser", fields: [createdBy], references: [id])
  toolsUpdatedBy  User?            @relation("ToolsUpdatedByUser", fields: [updatedBy], references: [id])
  warehouseStocks WarehouseStock[]
  stockMovements  StockMovement[]
}
