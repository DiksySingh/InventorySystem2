generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(uuid())
  name         String?
  email        String?  @unique
  contact      String?
  password     String?
  roleId       String?
  block        String?
  district     String?
  state        String?
  isActive     Boolean?
  refreshToken String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt

  updatedItems          ItemRawMaterial[]            @relation("UserUpdates")
  stocks                StockMovement[]
  services              ServiceRecord[] // One-to-Many relationship with ServiceRecord
  productionLogs        ProductionLog[]
  role                  Role?                        @relation(fields: [roleId], references: [id])
  stageActivity         StageActivity[]
  itemUsage             ItemUsage[]
  requestedItemRequests ItemRequestData[]            @relation("RequestedByUser")
  approvedItemRequests  ItemRequestData[]            @relation("ApprovedByUser")
  updatedItemRequests   ItemRequestData[]            @relation("UpdatedByUser")
  declinedItemRequests  ItemRequestData[]            @relation("DeclinedByUser")
  createdServiceProcess Service_Process_Record[]     @relation("CreatedByUser")
  updatedServiceProcess Service_Process_Record[]     @relation("UpdatedByUser")
  userItemStock         UserItemStock[]
  stockMovementBatch    StockMovementBatch[]
  Company               Company[]
  Vendor                Vendor[]
  BankDetail            BankDetail[]
  PurchaseOrder         PurchaseOrder[]
  PurchaseOrderReceipt  PurchaseOrderReceipt[]
  DamagedStock          DamagedStock[]
  disassembleTasks      Disassemble_Reusable_Items[] @relation("DisassembleEmployee")
  assembleStockReceives Disassemble_Reusable_Items[] @relation("AssembleEmployee")

  @@index([roleId], map: "User_roleId_fkey")
}

model Role {
  id        String   @id @default(uuid())
  name      String?  @unique
  createdAt DateTime @default(now())
  users     User[]
}

model Warehouse {
  id             String          @id @default(uuid())
  name           String?         @unique
  state          String?
  createdAt      DateTime        @default(now())
  stockMovements StockMovement[]
}

model Item {
  id                 String               @id @default(uuid())
  name               String?              @unique
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  rawMaterials       ItemRawMaterial[]
  manufacturingUsage ManufacturingUsage[]
  productionLogs     ProductionLog[]
  productItemMap     Product_Item_Map[]
}

model RawMaterial {
  id    String  @id @default(uuid())
  name  String? @unique
  stock Float?
  unit  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ItemRawMaterial     ItemRawMaterial[]
  manufacturingUsages ManufacturingUsage[]
  serviceUsages       ServiceUsage[]
  stockMovements      StockMovement[]
  itemUsage           ItemUsage[]
  userItemStock       UserItemStock[]
  stageRawMaterial    StageRawMaterial[]
}

model ItemRawMaterial {
  id            String   @id @default(uuid())
  itemId        String?
  itemModelId   String?
  rawMaterialId String?
  quantity      Float?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  updatedBy     String?

  user        User?        @relation("UserUpdates", fields: [updatedBy], references: [id])
  item        Item?        @relation(fields: [itemId], references: [id])
  rawMaterial RawMaterial? @relation(fields: [rawMaterialId], references: [id])
  itemModel   Item_Model?  @relation(fields: [itemModelId], references: [id])

  @@unique([itemId, rawMaterialId])
  @@index([rawMaterialId], map: "ItemRawMaterial_rawMaterialId_fkey")
}

model StageRawMaterial {
  id            String    @id @default(uuid())
  stageId       String?
  rawMaterialId String?
  createdAt     DateTime? @default(now())
  updatedAt     DateTime? @updatedAt

  stage       Stage?       @relation(fields: [stageId], references: [id])
  rawMaterial RawMaterial? @relation(fields: [rawMaterialId], references: [id])

  @@unique([stageId, rawMaterialId])
}

model StockMovementBatch {
  id         String    @id @default(uuid())
  billPhotos Json? // Array of URLs stored as JSON
  createdAt  DateTime? @default(now())
  createdBy  String?

  user          User?           @relation(fields: [createdBy], references: [id])
  stockMovement StockMovement[]
}

model StockMovement {
  id            String   @id @default(uuid())
  batchId       String?
  rawMaterialId String?
  userId        String?
  warehouseId   String?
  quantity      Float?
  unit          String?
  type          String?
  timestamp     DateTime @default(now())

  rawMaterial RawMaterial?        @relation(fields: [rawMaterialId], references: [id])
  warehouse   Warehouse?          @relation(fields: [warehouseId], references: [id])
  user        User?               @relation(fields: [userId], references: [id])
  batch       StockMovementBatch? @relation(fields: [batchId], references: [id])

  @@index([rawMaterialId], map: "StockMovement_rawMaterialId_fkey")
  @@index([warehouseId], map: "StockMovement_warehouseId_fkey")
}

model ManufacturingUsage {
  id                String       @id @default(uuid())
  itemId            String?
  rawMaterialId     String?
  quantityUsed      Float?
  unit              String? // Reference to Unit 
  manufacturingDate DateTime     @default(now())
  item              Item?        @relation(fields: [itemId], references: [id])
  rawMaterial       RawMaterial? @relation(fields: [rawMaterialId], references: [id])

  @@index([itemId], map: "ManufacturingUsage_itemId_fkey")
  @@index([rawMaterialId], map: "ManufacturingUsage_rawMaterialId_fkey")
}

model ProductionLog {
  id                String   @id @default(uuid())
  itemId            String
  subItem           String // NEW FIELD
  quantityProduced  Int
  manufacturingDate DateTime @default(now())
  userId            String
  item              Item?    @relation(fields: [itemId], references: [id])
  user              User?    @relation(fields: [userId], references: [id])
}

model ServiceRecord {
  id                 String   @id @default(uuid()) // Unique Service Record ID
  item               String? // Main item being repaired (e.g., motor)  //Motor
  subItem            String? // Sub-item (e.g., capacitor, fuse) //MOTOR 10HP AC 380V
  quantity           Float? // Quantity of items handled    //1
  serialNumber       String? // Serial number of the serviced item //ABCB1234
  faultAnalysis      Json? // Description of the fault or issue found  //Stamp Damaged
  isRepaired         Boolean? // Whether the main item was fixed //true
  repairedRejectedBy String? // Name of the technician //Shiv
  remarks            String? // Additional repair notes // Defective Items
  repairedParts      Json? // Array of objects: [{ rawMaterialId: "123", quantity: 2 }]
  initialRCA         Json?

  userId String // User who created the record (foreign key)
  user   User   @relation(fields: [userId], references: [id]) // Relationship to User model

  servicedAt DateTime @default(now()) // Service date
  updatedAt  DateTime @updatedAt // Automatically updated timestamp

  serviceUsages ServiceUsage[] // Relationship to parts usage

  @@index([serialNumber], map: "ServiceRecord_serialNumber_idx") // Index on serialNumber for fast lookups
  @@index([userId], map: "ServiceRecord_userId_idx") // Index on userId for efficient queries
}

model ServiceUsage {
  id            String  @id @default(uuid()) // Unique ID
  serviceId     String // Foreign key to ServiceRecord (One-to-Many)
  rawMaterialId String? // Material/part used
  quantityUsed  Float? // Quantity used in this service
  // isRepaired    Boolean?       // Indicates if the part was repaired/replaced
  // remarks       String?        // Additional notes for this part usage
  unit          String? // Reference to Unit

  // Relationships
  rawMaterial RawMaterial?   @relation(fields: [rawMaterialId], references: [id]) // Part reference
  service     ServiceRecord? @relation(fields: [serviceId], references: [id]) // Linked service record

  // Timestamps
  createdAt DateTime @default(now()) // Record creation time
  updatedAt DateTime @updatedAt // Last modification time

  @@index([serviceId], map: "ServiceUsage_serviceId_fkey") // Index for service lookups
  @@index([rawMaterialId], map: "ServiceUsage_rawMaterialId_fkey") // Index for material lookups
}

model Unit {
  id        String   @id @default(uuid())
  name      String   @unique // Example: "kg", "liters", "pieces"
  createdAt DateTime @default(now())
}

model Stage {
  id                               String                   @id @default(uuid())
  name                             String                   @unique
  description                      String?
  createdAt                        DateTime                 @default(now())
  updatedAt                        DateTime                 @updatedAt
  stageActivity                    StageActivity[]
  serviceProcess                   Service_Process_Record[]
  itemTypeStage                    ItemType_Stage[]
  serviceProcessInitialStage       Service_Process_Record[] @relation("InitialStage")
  serviceProcessRestartedFromStage Service_Process_Record[] @relation("RestartedFrom")
  stageFlowCurrentStage            StageFlow[]              @relation("CurrentStage")
  stageFlowNextStage               StageFlow[]              @relation("NextStage")
  failureRedirectStage             FailureRedirect[]
  stageRawMaterial                 StageRawMaterial[]

  @@map("Stage")
}

model ItemType {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  serviceProcess  Service_Process_Record[]
  itemTypeStage   ItemType_Stage[]
  stageFlow       StageFlow[]
  failureRedirect FailureRedirect[]

  @@map("ItemType")
}

enum FailureReason {
  VIBRATION
  OVERLOAD
  EARTHING
  LEAKAGE
  REJECTED
  OTHER
}

enum ActivityStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  REJECTED
  SKIPPED
}

model StageActivity {
  id               String         @id @default(uuid())
  serviceProcessId String?
  empId            String?
  stageId          String?
  status           ActivityStatus @default(PENDING)
  isCurrent        Boolean        @default(false)
  failureReason    FailureReason?
  remarks          String?
  outcome          String?
  acceptedAt       DateTime?
  startedAt        DateTime?
  completedAt      DateTime?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  serviceProcess Service_Process_Record? @relation(fields: [serviceProcessId], references: [id])
  stage          Stage?                  @relation(fields: [stageId], references: [id])
  user           User?                   @relation(fields: [empId], references: [id])

  @@map("StageActivity")
}

model ItemType_Stage {
  id         String   @id @default(uuid())
  itemTypeId String?
  stageId    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  itemType ItemType? @relation(fields: [itemTypeId], references: [id])
  stage    Stage?    @relation(fields: [stageId], references: [id])

  @@map("ItemType_Stage")
}

model ItemRequestData {
  id                   String    @id @default(uuid())
  serviceProcessId     String?
  isProcessRequest     Boolean   @default(false) // true = tied to specific process, false = advance/global
  rawMaterialRequested Json?
  requestedTo          String?
  requestedBy          String?
  requestedAt          DateTime  @default(now())
  approved             Boolean?
  approvedBy           String?
  approvedAt           DateTime?
  declined             Boolean?
  declinedBy           String?
  declinedAt           DateTime?
  declinedRemarks      String?
  materialGiven        Boolean?
  updatedAt            DateTime? @updatedAt
  updatedBy            String?

  //Relation
  serviceProcess  Service_Process_Record? @relation(fields: [serviceProcessId], references: [id])
  requestedByUser User?                   @relation("RequestedByUser", fields: [requestedBy], references: [id])
  approvedByUser  User?                   @relation("ApprovedByUser", fields: [approvedBy], references: [id])
  updatedByUser   User?                   @relation("UpdatedByUser", fields: [updatedBy], references: [id])
  declinedByUser  User?                   @relation("DeclinedByUser", fields: [declinedBy], references: [id])

  @@map("ItemRequestData")
}

enum ProcessStatus {
  PENDING
  IN_PROGRESS
  FAILED
  REDIRECTED
  COMPLETED
}

model Service_Process_Record {
  id                   String         @id @default(uuid())
  productName          String?
  itemName             String?
  subItemName          String?
  itemTypeId           String?
  serialNumber         String?
  quantity             Float?
  stageId              String?
  initialStageId       String? // NEW - where it originally started
  restartedFromStageId String? // NEW - where it restarted from
  status               ProcessStatus  @default(PENDING)
  finalStatus          String? // REPAIRED, REJECTED, PRODUCED, FAILED
  isClosed             Boolean        @default(false)
  isRepaired           Boolean?
  finalRemarks         String?
  isDisassemblePending Boolean?       @default(false)
  disassembleSessionId String?
  disassembleStatus    ProcessStatus?
  createdAt            DateTime       @default(now())
  createdBy            String?
  updatedAt            DateTime       @updatedAt
  updatedBy            String?
  completedAt          DateTime?

  itemType           ItemType? @relation(fields: [itemTypeId], references: [id])
  stage              Stage?    @relation(fields: [stageId], references: [id])
  initialStage       Stage?    @relation("InitialStage", fields: [initialStageId], references: [id])
  restartedFromStage Stage?    @relation("RestartedFrom", fields: [restartedFromStageId], references: [id])

  createdUser User? @relation("CreatedByUser", fields: [createdBy], references: [id])
  updatedUser User? @relation("UpdatedByUser", fields: [updatedBy], references: [id])

  itemRequestData     ItemRequestData[]
  stageActivity       StageActivity[]
  serviceProcessUsage ItemUsage[]
  reusableItems       Disassemble_Reusable_Items[]

  @@index([serialNumber])
  @@index([itemName])
  @@index([subItemName])
  @@index([createdAt])
  @@index([stageId])
  @@index([itemTypeId])
  @@index([status])
  @@map("Service_Process_Record")
}

model StageFlow {
  id             String   @id @default(uuid())
  productId      String?
  itemTypeId     String?
  currentStageId String?
  nextStageId    String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  product      Product?  @relation(fields: [productId], references: [id])
  itemType     ItemType? @relation(fields: [itemTypeId], references: [id])
  currentStage Stage?    @relation("CurrentStage", fields: [currentStageId], references: [id])
  nextStage    Stage?    @relation("NextStage", fields: [nextStageId], references: [id])

  @@map("StageFlow")
}

model FailureRedirect {
  id              String        @id @default(uuid())
  productId       String?
  itemTypeId      String? // Optional if universal
  failureReason   FailureReason
  redirectStageId String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  itemType      ItemType? @relation(fields: [itemTypeId], references: [id])
  redirectStage Stage?    @relation(fields: [redirectStageId], references: [id])
  product       Product?  @relation(fields: [productId], references: [id])

  @@map("FailureRedirect")
}

model ItemUsage {
  id               String  @id @default(uuid())
  serviceProcessId String?
  empId            String?
  rawMaterialId    String?
  quantityUsed     Float?
  unit             String?

  rawMaterial    RawMaterial?            @relation(fields: [rawMaterialId], references: [id])
  serviceProcess Service_Process_Record? @relation(fields: [serviceProcessId], references: [id])
  user           User?                   @relation(fields: [empId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("ItemUsage")
}

model UserItemStock {
  id            String   @id @default(uuid())
  empId         String?
  rawMaterialId String?
  quantity      Float    @default(0)
  unit          String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user        User?        @relation(fields: [empId], references: [id])
  rawMaterial RawMaterial? @relation(fields: [rawMaterialId], references: [id])

  @@unique([empId, rawMaterialId])
  @@map("UserItemStock")
}

model Disassemble_Reusable_Items {
  id               String   @id @default(uuid())
  serviceProcessId String
  empId            String?
  assembleEmpId    String?
  reusableItems    Json?
  remarks          String?
  createdAt        DateTime @default(now())

  disassembleEmp       User?                  @relation("DisassembleEmployee", fields: [empId], references: [id])
  assembleEmp          User?                  @relation("AssembleEmployee", fields: [assembleEmpId], references: [id])
  serviceProcessRecord Service_Process_Record @relation(fields: [serviceProcessId], references: [id])
}

model Item_Model {
  id        String   @id @default(uuid())
  model     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  itemRawMaterial ItemRawMaterial[]
}

model BOMEntry {
  id            String  @id @default(uuid())
  itemId        String?
  rawMaterialId String?
  quantity      Float?
}


enum Country {
  INDIA
  USA
  UAE
  UK
  CHINA
  RUSSIA
  OTHER
}

enum Currency {
  INR
  USD
  EUR
  GBP
  AED
  CNY
  OTHER
}

enum GSTType {
  IGST_5
  IGST_12
  IGST_18
  IGST_28
  IGST_EXEMPTED


  LGST_5
  LGST_12
  LGST_18
  LGST_28
  LGST_EXEMPTED

  IGST_ITEMWISE
  LGST_ITEMWISE
}

enum POStatus {
  Draft
  Generated_Downloaded
  PartiallyReceived
  Received
  Cancelled
}

enum PaymentMode {
  Cash
  NEFT
  UPI
  Cheque
}


model Product {
  id          String   @id @default(uuid())
  productName String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  productItemMap  Product_Item_Map[]
  stageFlow       StageFlow[]
  failureRedirect FailureRedirect[]
}


model Product_Item_Map {
  id        String   @id @default(uuid())
  productId String?
  itemId    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product Product? @relation(fields: [productId], references: [id])
  item    Item?    @relation(fields: [itemId], references: [id])

  @@unique([productId, itemId], name: "unique_product_item")
}


model PanelMaster {
  id         String   @id @default(uuid())
  panelType  String?
  moduleType String?
  dcrType    String?
  wattage    String?
  hsnCode    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}


model Company {
  id              String   @id @default(uuid())
  name            String
  companyCode     String?
  gstNumber       String?
  address         String?
  city            String?
  state           String?
  pincode         String?
  contactNumber   String?
  alternateNumber String?
  email           String?
  country         Country  @default(INDIA)
  currency        Currency @default(INR)
  createdBy       String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  purchaseOrders PurchaseOrder[]
  bankAccounts   BankDetail[]
  user           User            @relation(fields: [createdBy], references: [id])
}

model Vendor {
  id              String   @id @default(uuid())
  name            String
  email           String?
  gstNumber       String?
  address         String?
  city            String?
  state           String?
  pincode         String?
  country         Country  @default(INDIA)
  currency        Currency @default(INR)
  contactNumber   String?
  alternateNumber String?
  createdBy       String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  purchaseOrders PurchaseOrder[]
  bankAccounts   BankDetail[]
  returnToVendor ReturnToVendor[]
  user           User             @relation(fields: [createdBy], references: [id])
}


model BankDetail {
  id            String   @id @default(uuid())
  accountHolder String
  bankName      String
  branchName    String?
  accountNumber String
  ifscCode      String
  accountType   String?  @default("Current")
  isPrimary     Boolean  @default(false)
  vendorId      String?
  companyId     String?
  createdBy     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  vendor         Vendor?         @relation(fields: [vendorId], references: [id])
  company        Company?        @relation(fields: [companyId], references: [id])
  user           User?           @relation(fields: [createdBy], references: [id])
  purchaseOrders PurchaseOrder[]
}


model Counter {
  id            String  @id @default(uuid())
  name          String  @unique
  companyId     String?
  financialYear String?
  seq           Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


model PurchaseOrder {
  id            String   @id @default(uuid())
  poNumber      String   @unique
  financialYear String?
  companyId     String
  companyName   String?
  vendorId      String
  vendorName    String?
  bankDetailId  String?
  createdBy     String?
  poDate        DateTime @default(now())
  gstType       GSTType
  gstRate       Decimal? @db.Decimal(5, 2)

  
  currency     String?  @default("INR")
  exchangeRate Decimal? @default(1.0000) @db.Decimal(12, 4) 

  foreignSubTotal   Decimal? @db.Decimal(12, 2) 
  foreignGrandTotal Decimal? @db.Decimal(12, 2) 
  

  subTotal          Decimal?  @db.Decimal(12, 2)
  totalCGST         Decimal?  @db.Decimal(12, 2)
  totalSGST         Decimal?  @db.Decimal(12, 2)
  totalIGST         Decimal?  @db.Decimal(12, 2)
  totalGST          Decimal?  @db.Decimal(12, 2)
  grandTotal        Decimal?  @db.Decimal(12, 2)
  status            POStatus  @default(Draft)
  remarks           String?
  pdfUrl            String?
  pdfName           String?
  pdfGeneratedAt    DateTime?
  pdfGeneratedBy    String?
  emailSentAt       DateTime?
  emailSentBy       String?
  emailResentCount  Int       @default(0)
  emailLastResentAt DateTime?
  paymentTerms      String?
  deliveryTerms     String?
  contactPerson     String?
  cellNo            String?
  warranty          String?
 
  otherCharges      Json?
 
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  company        Company                @relation(fields: [companyId], references: [id])
  vendor         Vendor                 @relation(fields: [vendorId], references: [id])
  bankDetail     BankDetail?            @relation(fields: [bankDetailId], references: [id])
  items          PurchaseOrderItem[]
  payments       Payment[]
  returnToVendor ReturnToVendor[]
  damagedStock   DamagedStock[]
  receipts       PurchaseOrderReceipt[] @relation("PO_Receipts") // PO → Receipts
  bills          PurchaseOrderBill[]
  user           User?                  @relation(fields: [createdBy], references: [id])
}

model PurchaseOrderItem {
  id              String   @id @default(uuid())
  purchaseOrderId String
  itemId          String
  itemSource      String
  itemName        String
  hsnCode         String?
  modelNumber     String?
  itemDetail      String?  @db.VarChar(500)
  unit            String?
  rate            Decimal  @db.Decimal(10, 2)
  gstRate         Decimal? @db.Decimal(5, 2)
  quantity        Decimal  @db.Decimal(10, 2)
  receivedQty     Decimal? @default(0) @db.Decimal(10, 2)
  itemGSTType     String?
  total           Decimal  @db.Decimal(12, 2)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  returnToVendor ReturnToVendor[]
  purchaseOrder  PurchaseOrder          @relation(fields: [purchaseOrderId], references: [id])
  receipts       PurchaseOrderReceipt[] @relation("Item_Receipts") // Item → Receipts
}

model PurchaseOrderReceipt {
  id                  String   @id @default(uuid())
  purchaseOrderId     String?
  purchaseOrderItemId String?
  itemId              String?
  itemSource          String?
  itemName            String?
  receivedQty         Decimal? @db.Decimal(10, 2) 
  goodQty             Decimal? @default(0) @db.Decimal(10, 2) 
  damagedQty          Decimal? @default(0) @db.Decimal(10, 2) 
 
  receivingBill       String?
  receivedDate        DateTime @default(now())
  remarks             String?
  createdBy           String?
  createdAt           DateTime @default(now())

  returnToVendor    ReturnToVendor[]
  purchaseOrder     PurchaseOrder?     @relation("PO_Receipts", fields: [purchaseOrderId], references: [id])
  purchaseOrderItem PurchaseOrderItem? @relation("Item_Receipts", fields: [purchaseOrderItemId], references: [id])
  user              User?              @relation(fields: [createdBy], references: [id])
}

model DamagedStock {
  id              String   @id @default(uuid())
  purchaseOrderId String?
  itemId          String?
  itemSource      String?
  itemName        String?
  quantity        Int      @default(0)
  remarks         String? 
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String?

  purchaseOrder PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id])
  user          User?          @relation(fields: [createdBy], references: [id])
}

model PurchaseOrderBill {
  id              String   @id @default(uuid())
  purchaseOrderId String
  fileName        String
  fileUrl         String
  mimeType        String
  uploadedBy      String
  createdAt       DateTime @default(now())

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
}


model ReturnToVendor {
  id                  String       @id @default(uuid())
  returnNumber        String       @unique
  purchaseOrderId     String
  purchaseOrderItemId String?
  receiptId           String? // Link to the specific receipt that caused the return
  vendorId            String
  reason              String?
  damagedQty          Decimal      @db.Decimal(10, 2)
  returnDate          DateTime     @default(now())
  transporterName     String?
  vehicleNo           String?
  challanNo           String?
  pdfUrl              String?
  createdBy           String?
  status              ReturnStatus @default(Pending)
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

 
  vendor            Vendor                @relation(fields: [vendorId], references: [id])
  purchaseOrder     PurchaseOrder         @relation(fields: [purchaseOrderId], references: [id])
  purchaseOrderItem PurchaseOrderItem?    @relation(fields: [purchaseOrderItemId], references: [id])
  receipt           PurchaseOrderReceipt? @relation(fields: [receiptId], references: [id])
}

enum ReturnStatus {
  Pending 
  InTransit 
  ReceivedByVendor 
  Closed
}

model Payment {
  id          String      @id @default(uuid())
  poId        String
  paymentDate DateTime    @default(now())
  mode        PaymentMode @default(NEFT)
  amount      Decimal     @db.Decimal(12, 2)
  referenceNo String?
  remarks     String?
  createdAt   DateTime    @default(now())

  purchaseOrder PurchaseOrder @relation(fields: [poId], references: [id])
}


model AuditLog {
  id          String   @id @default(uuid())
  entityType  String 
  entityId    String 
  action      String 
  performedBy String? 
  oldValue    Json? 
  newValue    Json? 
  timestamp   DateTime @default(now())
}
